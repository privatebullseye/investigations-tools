<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Titan Securities Pty Ltd – s708 / Sophisticated Investor Register (AR/CAR)</title>
  <style>
    :root{
      --primary:#0b2a3c;
      --accent:#b71c1c;
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2328;
      --muted:#4b5563;
      --soft:#eef2f6;
      --border:#d9e1ea;
      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b91c1c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      background:var(--primary);
      color:#fff;
      padding:16px 18px;
    }
    header h1{
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 0 0;
      opacity:.92;
      font-size:12.5px;
      line-height:1.35;
    }
    main{
      max-width:1100px;
      margin:18px auto;
      padding:0 14px 26px 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, #ffffff, #fafbfc);
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      font-weight:700;
    }
    .card .hd .sub{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .card .bd{ padding:14px; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 720px){
      .row,.row3{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 0;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 10px;
      border-radius:10px;
      font-size:13.5px;
      color:var(--text);
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--soft);
      font-size:12.5px;
      color:var(--text);
    }
    .status{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--border);
      background:var(--primary);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:13.5px;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:var(--text);
    }
    button.danger{
      background:var(--bad);
      border-color: #8b0f0f;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .note{
      background: #fff7ed;
      border:1px solid #fed7aa;
      color:#7c2d12;
      padding:10px 12px;
      border-radius:12px;
      font-size:12.5px;
      line-height:1.35;
    }
    .ok{
      background:#ecfdf5;
      border:1px solid #a7f3d0;
      color:#065f46;
      padding:10px 12px;
      border-radius:12px;
      font-size:12.5px;
      line-height:1.35;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12.5px;
    }
    thead th{
      text-align:left;
      padding:10px 10px;
      background:var(--soft);
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      color:var(--muted);
      font-weight:700;
    }
    thead th:first-child{ border-left:1px solid var(--border); border-top-left-radius:10px; }
    thead th:last-child{ border-right:1px solid var(--border); border-top-right-radius:10px; }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      border-left:1px solid var(--border);
      background:#fff;
      vertical-align:top;
    }
    tbody tr td:last-child{ border-right:1px solid var(--border); }
    tbody tr:last-child td:first-child{ border-bottom-left-radius:10px; }
    tbody tr:last-child td:last-child{ border-bottom-right-radius:10px; }

    .tiny{ font-size:11.5px; color:var(--muted); line-height:1.35; }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi .box{
      flex:1 1 150px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
    }
    .kpi .box .n{
      font-size:20px;
      font-weight:700;
      margin:0;
      color:var(--primary);
    }
    .kpi .box .l{
      margin:2px 0 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .inline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .lock{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .lock input{ max-width:200px; }
    .muted{ color:var(--muted); }
  </style>
</head>

<body>
<header>
  <h1>Titan Securities Pty Ltd – s708 / Sophisticated Investor Register</h1>
  <p>
    Use this page to record each wholesale prospect or client you deal with under s708 (sophisticated / professional / other wholesale pathways),
    so Titan can verify the supporting paperwork and retain evidence for AFSL supervision.
  </p>
</header>

<main>
  <div class="grid">

    <!-- LEFT: ENTRY FORM -->
    <section class="card">
      <div class="hd">
        <h2>New entry</h2>
        <div class="sub">
          Record the interaction promptly. Attach the supporting s708 evidence separately (email/secure upload) and reference it below.
        </div>
      </div>

      <div class="bd">
        <div class="lock" id="lockBox">
          <div>
            <div style="font-weight:700;">Access code</div>
            <div class="tiny">Optional. If you do not want a code, delete the lock section in the HTML.</div>
          </div>
          <div class="inline">
            <input id="accessCode" type="password" placeholder="Enter code" autocomplete="current-password" />
            <button type="button" class="secondary" id="unlockBtn">Unlock</button>
          </div>
        </div>

        <div id="appArea" style="display:none; margin-top:14px;">
          <div class="row3">
            <div>
              <label for="entryDate">Entry date (today)</label>
              <input id="entryDate" type="date" />
            </div>
            <div>
              <label for="operatorName">AR / Operator name</label>
              <input id="operatorName" type="text" placeholder="e.g., Richard Lie" />
            </div>
            <div>
              <label for="operatorEntity">CAR entity (if applicable)</label>
              <input id="operatorEntity" type="text" placeholder="e.g., V2U Research Pty Ltd (optional)" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="investorName">Investor full name</label>
              <input id="investorName" type="text" placeholder="Full legal name" />
            </div>
            <div>
              <label for="investorEntity">Investor company or trust (if applicable)</label>
              <input id="investorEntity" type="text" placeholder="Company / trustee name (optional)" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="investorEmail">Investor email</label>
              <input id="investorEmail" type="email" placeholder="name@email.com" />
            </div>
            <div>
              <label for="investorPhone">Investor phone</label>
              <input id="investorPhone" type="tel" placeholder="Mobile or landline" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label for="pathway">Wholesale pathway (what you relied on)</label>
              <select id="pathway">
                <option value="">Select…</option>
                <option value="s708(8) Sophisticated (Accountant Certificate)">s708(8) Sophisticated (Accountant Certificate)</option>
                <option value="s708(10) Sophisticated (>$500k investment)">s708(10) Sophisticated (>$500k investment)</option>
                <option value="Professional Investor s708(11)">Professional Investor s708(11)</option>
                <option value="Other wholesale basis (specify in notes)">Other wholesale basis (specify in notes)</option>
              </select>
            </div>
            <div>
              <label for="offerProduct">Offer / Product / Strategy</label>
              <input id="offerProduct" type="text" placeholder="e.g., Equity placement / Fund / Strategy name" />
            </div>
            <div>
              <label for="dealStage">Stage</label>
              <select id="dealStage">
                <option value="">Select…</option>
                <option value="Prospect only (no offer yet)">Prospect only (no offer yet)</option>
                <option value="Offer made / documents sent">Offer made / documents sent</option>
                <option value="Committed / applied">Committed / applied</option>
                <option value="Invested / settled">Invested / settled</option>
                <option value="Declined">Declined</option>
              </select>
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label for="amount">Amount (AUD)</label>
              <input id="amount" type="text" placeholder="e.g., 250,000" />
            </div>
            <div>
              <label for="certDate">Accountant certificate date (if used)</label>
              <input id="certDate" type="date" />
            </div>
            <div>
              <label for="certExpiry">Certificate expiry (if known)</label>
              <input id="certExpiry" type="date" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="accountantName">Accountant name / firm (if applicable)</label>
              <input id="accountantName" type="text" placeholder="Accountant / firm name (optional)" />
            </div>
            <div>
              <label for="evidenceRef">Evidence reference (required)</label>
              <input id="evidenceRef" type="text" placeholder="e.g., Email sent 07/01/2026 14:05 with PDF certificate, filename, link, or internal ref" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="fsgProvided">FSG / relevant disclosures provided</label>
              <select id="fsgProvided">
                <option value="">Select…</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Not applicable / already on file">Not applicable / already on file</option>
              </select>
            </div>
            <div>
              <label for="wholesaleConfirmed">Wholesale status confirmed before dealing</label>
              <select id="wholesaleConfirmed">
                <option value="">Select…</option>
                <option value="Yes">Yes</option>
                <option value="Pending (do not proceed)">Pending (do not proceed)</option>
                <option value="No (do not proceed)">No (do not proceed)</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="notes">Notes (what happened, what was sent, any risk flags)</label>
            <textarea id="notes" placeholder="Short factual notes. Include any red flags, missing paperwork, follow-ups required."></textarea>
          </div>

          <div class="status">
            <span class="pill">Storage: this page uses your browser localStorage</span>
            <span class="pill">Export: CSV / JSON buttons (send to Titan)</span>
          </div>

          <div class="btns">
            <button type="button" id="saveBtn">Save entry</button>
            <button type="button" class="secondary" id="clearBtn">Clear form</button>
          </div>

          <div style="margin-top:12px;" class="note">
            Privacy note: Do not store unnecessary personal data. Record only what Titan needs to verify s708 evidence and supervision steps.
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: REGISTER + EXPORT -->
    <aside class="card">
      <div class="hd">
        <h2>Register</h2>
        <div class="sub">
          Review what you have logged on this device. Export and email to Titan when requested (or after each new entry).
        </div>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <p class="n" id="kpiTotal">0</p>
            <p class="l">Total entries on this device</p>
          </div>
          <div class="box">
            <p class="n" id="kpiPending">0</p>
            <p class="l">Pending wholesale confirmation</p>
          </div>
          <div class="box">
            <p class="n" id="kpiMissing">0</p>
            <p class="l">Missing evidence reference</p>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label for="filterText">Quick filter</label>
            <input id="filterText" type="text" placeholder="Search by operator, investor, pathway, product…" />
          </div>
          <div>
            <label for="sortBy">Sort</label>
            <select id="sortBy">
              <option value="newest">Newest first</option>
              <option value="oldest">Oldest first</option>
              <option value="operator">Operator A–Z</option>
              <option value="investor">Investor A–Z</option>
            </select>
          </div>
        </div>

        <div class="btns" style="margin-top:12px;">
          <button type="button" class="secondary" id="exportCsvBtn">Export CSV</button>
          <button type="button" class="secondary" id="exportJsonBtn">Export JSON</button>
          <button type="button" class="secondary" id="copySummaryBtn">Copy email summary</button>
          <button type="button" class="danger" id="wipeBtn">Wipe local register</button>
        </div>

        <div id="msgArea" style="margin-top:12px;"></div>

        <div style="margin-top:14px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="min-width:120px;">Date</th>
                <th style="min-width:150px;">Operator</th>
                <th style="min-width:190px;">Investor</th>
                <th style="min-width:220px;">Pathway / Product</th>
                <th style="min-width:170px;">Evidence ref</th>
                <th style="min-width:110px;">Status</th>
                <th style="min-width:110px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <p class="tiny" style="margin-top:12px;">
          Tip: if you are moving devices, export JSON, then paste/import by replacing the localStorage key in code (or send JSON to Titan to consolidate).
        </p>
      </div>
    </aside>

  </div>
</main>

<script>
(function(){
  // ===== SETTINGS =====
  // Change or remove this if you do not want a code gate.
  const ACCESS_CODE = "titan";
  const SESSION_KEY = "titan_708_unlocked";
  const STORAGE_KEY = "titan_708_register_v1";

  // ===== HELPERS =====
  const $ = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tzOff = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tzOff*60000);
    return local.toISOString().slice(0,10);
  }

  function safeText(v){
    return (v || "").toString().trim();
  }

  function loadRegister(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      if(Array.isArray(data)) return data;
      return [];
    }catch(e){
      return [];
    }
  }

  function saveRegister(rows){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function setMsg(type, text){
    const el = $("msgArea");
    if(!text){ el.innerHTML = ""; return; }
    const cls = type === "ok" ? "ok" : "note";
    el.innerHTML = '<div class="'+cls+'">'+escapeHtml(text)+'</div>';
  }

  function toCSV(rows){
    const headers = [
      "EntryID","EntryDate","OperatorName","OperatorEntity",
      "InvestorName","InvestorEntity","InvestorEmail","InvestorPhone",
      "Pathway","OfferProduct","DealStage","AmountAUD",
      "CertDate","CertExpiry","AccountantName",
      "FSGProvided","WholesaleConfirmed","EvidenceRef","Notes","CreatedAt"
    ];
    const esc = (v) => {
      const s = (v ?? "").toString();
      const needs = /[",\n\r]/.test(s);
      const cleaned = s.replace(/"/g,'""');
      return needs ? `"${cleaned}"` : cleaned;
    };
    const lines = [headers.join(",")];
    rows.forEach(r=>{
      lines.push(headers.map(h => esc(r[h])).join(","));
    });
    return lines.join("\n");
  }

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);
  }

  function computeKPIs(rows){
    const total = rows.length;
    const pending = rows.filter(r => (r.WholesaleConfirmed || "") === "Pending (do not proceed)").length;
    const missing = rows.filter(r => !safeText(r.EvidenceRef)).length;
    $("kpiTotal").textContent = total;
    $("kpiPending").textContent = pending;
    $("kpiMissing").textContent = missing;
  }

  function render(){
    const rows = loadRegister();

    const filter = safeText($("filterText").value).toLowerCase();
    const sortBy = $("sortBy").value;

    let view = rows.slice();

    if(filter){
      view = view.filter(r=>{
        const blob = [
          r.EntryDate, r.OperatorName, r.OperatorEntity,
          r.InvestorName, r.InvestorEntity, r.InvestorEmail, r.InvestorPhone,
          r.Pathway, r.OfferProduct, r.DealStage, r.AmountAUD,
          r.CertDate, r.CertExpiry, r.AccountantName,
          r.FSGProvided, r.WholesaleConfirmed, r.EvidenceRef, r.Notes
        ].join(" ").toLowerCase();
        return blob.includes(filter);
      });
    }

    if(sortBy === "newest"){
      view.sort((a,b)=> (b.EntryDate||"").localeCompare(a.EntryDate||"") || (b.CreatedAt||"").localeCompare(a.CreatedAt||""));
    }else if(sortBy === "oldest"){
      view.sort((a,b)=> (a.EntryDate||"").localeCompare(b.EntryDate||"") || (a.CreatedAt||"").localeCompare(b.CreatedAt||""));
    }else if(sortBy === "operator"){
      view.sort((a,b)=> (a.OperatorName||"").localeCompare(b.OperatorName||""));
    }else if(sortBy === "investor"){
      view.sort((a,b)=> (a.InvestorName||"").localeCompare(b.InvestorName||""));
    }

    computeKPIs(rows);

    const tbody = $("tbody");
    tbody.innerHTML = "";

    if(view.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="muted">No entries found on this device.</td>`;
      tbody.appendChild(tr);
      return;
    }

    view.forEach(r=>{
      const status =
        (r.WholesaleConfirmed === "Yes" && safeText(r.EvidenceRef)) ? "OK" :
        (r.WholesaleConfirmed && r.WholesaleConfirmed.includes("Pending")) ? "Pending" :
        (!safeText(r.EvidenceRef)) ? "Missing evidence" :
        "Review";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.EntryDate || "")}</td>
        <td>
          ${escapeHtml(r.OperatorName || "")}
          <div class="tiny">${escapeHtml(r.OperatorEntity || "")}</div>
        </td>
        <td>
          ${escapeHtml(r.InvestorName || "")}
          <div class="tiny">${escapeHtml(r.InvestorEntity || "")}</div>
        </td>
        <td>
          ${escapeHtml(r.Pathway || "")}
          <div class="tiny">${escapeHtml(r.OfferProduct || "")}</div>
        </td>
        <td>${escapeHtml(r.EvidenceRef || "")}</td>
        <td>${escapeHtml(status)}</td>
        <td>
          <button type="button" class="secondary" data-act="view" data-id="${escapeHtml(r.EntryID)}">View</button>
          <button type="button" class="danger" data-act="del" data-id="${escapeHtml(r.EntryID)}" style="margin-top:6px;">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearForm(){
    $("entryDate").value = todayISO();
    $("operatorName").value = "";
    $("operatorEntity").value = "";
    $("investorName").value = "";
    $("investorEntity").value = "";
    $("investorEmail").value = "";
    $("investorPhone").value = "";
    $("pathway").value = "";
    $("offerProduct").value = "";
    $("dealStage").value = "";
    $("amount").value = "";
    $("certDate").value = "";
    $("certExpiry").value = "";
    $("accountantName").value = "";
    $("fsgProvided").value = "";
    $("wholesaleConfirmed").value = "";
    $("evidenceRef").value = "";
    $("notes").value = "";
  }

  function collectForm(){
    const now = new Date();
    return {
      EntryID: "E" + now.getTime().toString(36) + Math.random().toString(36).slice(2,7).toUpperCase(),
      EntryDate: safeText($("entryDate").value),
      OperatorName: safeText($("operatorName").value),
      OperatorEntity: safeText($("operatorEntity").value),
      InvestorName: safeText($("investorName").value),
      InvestorEntity: safeText($("investorEntity").value),
      InvestorEmail: safeText($("investorEmail").value),
      InvestorPhone: safeText($("investorPhone").value),
      Pathway: safeText($("pathway").value),
      OfferProduct: safeText($("offerProduct").value),
      DealStage: safeText($("dealStage").value),
      AmountAUD: safeText($("amount").value),
      CertDate: safeText($("certDate").value),
      CertExpiry: safeText($("certExpiry").value),
      AccountantName: safeText($("accountantName").value),
      FSGProvided: safeText($("fsgProvided").value),
      WholesaleConfirmed: safeText($("wholesaleConfirmed").value),
      EvidenceRef: safeText($("evidenceRef").value),
      Notes: safeText($("notes").value),
      CreatedAt: now.toISOString()
    };
  }

  function validateEntry(e){
    const errs = [];
    if(!safeText(e.EntryDate)) errs.push("Entry date is required.");
    if(!safeText(e.OperatorName)) errs.push("Operator name is required.");
    if(!safeText(e.InvestorName)) errs.push("Investor name is required.");
    if(!safeText(e.Pathway)) errs.push("Wholesale pathway is required.");
    if(!safeText(e.EvidenceRef)) errs.push("Evidence reference is required (what you sent / where it is).");
    if(!safeText(e.WholesaleConfirmed)) errs.push("Wholesale confirmation status is required.");
    return errs;
  }

  function unlockIfAllowed(){
    const unlocked = sessionStorage.getItem(SESSION_KEY) === "1";
    $("appArea").style.display = unlocked ? "block" : "none";
    $("lockBox").style.display = unlocked ? "none" : "flex";
  }

  // ===== EVENTS =====
  $("unlockBtn").addEventListener("click", () => {
    const code = $("accessCode").value || "";
    if(code === ACCESS_CODE){
      sessionStorage.setItem(SESSION_KEY, "1");
      unlockIfAllowed();
      setMsg("ok","Unlocked for this browser session.");
      render();
    }else{
      setMsg("note","Incorrect access code.");
    }
  });

  $("saveBtn").addEventListener("click", () => {
    const entry = collectForm();
    const errs = validateEntry(entry);
    if(errs.length){
      setMsg("note", errs.join(" "));
      return;
    }
    const rows = loadRegister();
    rows.push(entry);
    saveRegister(rows);
    setMsg("ok","Saved. Export CSV or copy the email summary if you need to send it to Titan now.");
    render();
    clearForm();
  });

  $("clearBtn").addEventListener("click", () => {
    clearForm();
    setMsg("", "");
  });

  $("exportCsvBtn").addEventListener("click", () => {
    const rows = loadRegister();
    const csv = toCSV(rows);
    const filename = "titan_s708_register_" + todayISO() + ".csv";
    downloadFile(filename, csv, "text/csv;charset=utf-8");
    setMsg("ok","CSV exported.");
  });

  $("exportJsonBtn").addEventListener("click", () => {
    const rows = loadRegister();
    const json = JSON.stringify(rows, null, 2);
    const filename = "titan_s708_register_" + todayISO() + ".json";
    downloadFile(filename, json, "application/json;charset=utf-8");
    setMsg("ok","JSON exported.");
  });

  $("copySummaryBtn").addEventListener("click", async () => {
    const rows = loadRegister();
    const latest = rows.slice().sort((a,b)=> (b.CreatedAt||"").localeCompare(a.CreatedAt||""))[0];
    if(!latest){
      setMsg("note","No entries to summarise.");
      return;
    }
    const lines = [
      "Subject: s708 investor logged – " + (latest.InvestorName || "(Investor)") + " – " + (latest.Pathway || ""),
      "",
      "Hi Matthew,",
      "",
      "I have logged an s708 / wholesale investor interaction for supervision verification.",
      "",
      "Operator: " + (latest.OperatorName || "") + (latest.OperatorEntity ? " ("+latest.OperatorEntity+")" : ""),
      "Investor: " + (latest.InvestorName || "") + (latest.InvestorEntity ? " ("+latest.InvestorEntity+")" : ""),
      "Pathway: " + (latest.Pathway || ""),
      "Offer / Product: " + (latest.OfferProduct || ""),
      "Stage: " + (latest.DealStage || ""),
      "Wholesale confirmed: " + (latest.WholesaleConfirmed || ""),
      "FSG / disclosures provided: " + (latest.FSGProvided || ""),
      "Evidence reference: " + (latest.EvidenceRef || ""),
      (latest.CertDate ? "Certificate date: " + latest.CertDate : ""),
      (latest.CertExpiry ? "Certificate expiry: " + latest.CertExpiry : ""),
      (latest.AccountantName ? "Accountant: " + latest.AccountantName : ""),
      (latest.AmountAUD ? "Amount (AUD): " + latest.AmountAUD : ""),
      "",
      "Notes:",
      (latest.Notes || "(none)"),
      "",
      "Regards,"
    ].filter(Boolean);

    const text = lines.join("\n");
    try{
      await navigator.clipboard.writeText(text);
      setMsg("ok","Email summary copied to clipboard.");
    }catch(e){
      setMsg("note","Could not access clipboard. Copy manually from the View popup.");
    }
  });

  $("wipeBtn").addEventListener("click", () => {
    const ok = confirm("This will delete the local register on this device only. Continue?");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    setMsg("ok","Local register wiped on this device.");
    render();
  });

  $("filterText").addEventListener("input", render);
  $("sortBy").addEventListener("change", render);

  $("tbody").addEventListener("click", (ev) => {
    const btn = ev.target.closest("button");
    if(!btn) return;

    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    const rows = loadRegister();
    const idx = rows.findIndex(r => r.EntryID === id);
    if(idx === -1) return;

    if(act === "del"){
      const ok = confirm("Delete this entry from this device?");
      if(!ok) return;
      rows.splice(idx,1);
      saveRegister(rows);
      setMsg("ok","Entry deleted.");
      render();
      return;
    }

    if(act === "view"){
      const r = rows[idx];
      const detail = [
        "Entry ID: " + (r.EntryID || ""),
        "Entry date: " + (r.EntryDate || ""),
        "",
        "Operator: " + (r.OperatorName || "") + (r.OperatorEntity ? " ("+r.OperatorEntity+")" : ""),
        "Investor: " + (r.InvestorName || "") + (r.InvestorEntity ? " ("+r.InvestorEntity+")" : ""),
        "Email: " + (r.InvestorEmail || ""),
        "Phone: " + (r.InvestorPhone || ""),
        "",
        "Pathway: " + (r.Pathway || ""),
        "Offer / Product: " + (r.OfferProduct || ""),
        "Stage: " + (r.DealStage || ""),
        "Amount (AUD): " + (r.AmountAUD || ""),
        "",
        "Certificate date: " + (r.CertDate || ""),
        "Certificate expiry: " + (r.CertExpiry || ""),
        "Accountant: " + (r.AccountantName || ""),
        "",
        "FSG / disclosures provided: " + (r.FSGProvided || ""),
        "Wholesale confirmed: " + (r.WholesaleConfirmed || ""),
        "Evidence reference: " + (r.EvidenceRef || ""),
        "",
        "Notes:",
        (r.Notes || "(none)"),
        "",
        "Created at: " + (r.CreatedAt || "")
      ].join("\n");

      alert(detail);
      return;
    }
  });

  // ===== INIT =====
  $("entryDate").value = todayISO();

  // If you do not want a lock, uncomment this line and remove the lock section:
  // sessionStorage.setItem(SESSION_KEY, "1");

  unlockIfAllowed();
  render();

})();
</script>

</body>
</html>

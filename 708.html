<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Titan Securities Pty Ltd – s708 Investor Notification</title>
  <style>
    :root{
      --primary:#0b2a3c;
      --accent:#b71c1c;
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2328;
      --muted:#4b5563;
      --soft:#eef2f6;
      --border:#d9e1ea;
      --ok:#0f766e;
      --warn:#b45309;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--primary);color:#fff;padding:16px 18px;}
    header h1{margin:0;font-size:18px;font-weight:700;}
    header p{margin:6px 0 0 0;font-size:12.5px;opacity:.95;line-height:1.35;}
    main{max-width:1100px;margin:18px auto;padding:0 14px 28px 14px;}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04);}
    .card h2{margin:0 0 10px 0;font-size:15px;font-weight:700;}
    .note{background:var(--soft);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12.5px;color:var(--muted);line-height:1.4;}
    .note strong{color:var(--text);}
    .alert{border-radius:10px;padding:10px;font-size:12.5px;line-height:1.4;border:1px solid var(--border);background:#fff;}
    .alert.red{border-color:rgba(183,28,28,.35);background:rgba(183,28,28,.06);}
    .alert.green{border-color:rgba(15,118,110,.35);background:rgba(15,118,110,.06);}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media (max-width:650px){.row{grid-template-columns:1fr;}}
    label{display:block;font-size:12.5px;color:var(--muted);margin:0 0 6px 0;}
    input,select,textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:13.5px;outline:none;background:#fff;}
    textarea{min-height:120px;resize:vertical;}
    .small{font-size:12px;}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12.5px;color:var(--text);}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{border:0;border-radius:10px;padding:10px 12px;font-size:13.5px;cursor:pointer;}
    .primary{background:var(--primary);color:#fff;}
    .secondary{background:#111827;color:#fff;}
    .ghost{background:#fff;border:1px solid var(--border);color:var(--text);}
    .danger{background:var(--accent);color:#fff;}
    .status{margin-top:10px;font-size:12.5px;color:var(--muted);line-height:1.4;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,.08);overflow:auto;}
    .footer{margin-top:12px;font-size:11.5px;color:var(--muted);line-height:1.4;}
    .lock{position:fixed;inset:0;background:rgba(11,42,60,.78);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999;}
    .lockcard{width:min(520px,100%);background:#fff;border-radius:14px;padding:14px;border:1px solid rgba(0,0,0,.08);box-shadow:0 14px 40px rgba(0,0,0,.25);}
    .lockcard h2{margin:0 0 8px 0;font-size:16px;}
    .lockcard p{margin:0 0 10px 0;font-size:12.5px;color:var(--muted);line-height:1.4;}
  </style>
</head>

<body>
  <div class="lock" id="lock">
    <div class="lockcard">
      <h2>Restricted Access</h2>
      <p>
        This page is for Authorised Representatives and Corporate Authorised Representatives of Titan Securities Pty Ltd.
        Enter the shared password to continue.
      </p>
      <label for="pw">Password</label>
      <input id="pw" type="password" placeholder="Enter password" autocomplete="current-password" />
      <div class="btns">
        <button class="primary" id="unlockBtn" type="button">Unlock</button>
        <button class="ghost" id="clearBtn" type="button">Clear</button>
      </div>
      <div class="status" id="lockStatus"></div>
      <div class="footer">
        Note: This is a front end access gate only. Do not store confidential client documents on GitHub Pages.
      </div>
    </div>
  </div>

  <header>
    <h1>Titan Securities Pty Ltd – s708 Investor Notification</h1>
    <p>
      Purpose: This page creates a dated log entry for any investor you have dealt with under s708 (wholesale).
      This allows Titan to confirm the s708 paperwork is on file before dealing proceeds.
      This does not replace your local registers.
    </p>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>s708 Investor Notification Form</h2>

        <div class="alert red">
          <strong>Important:</strong>
          Do not proceed with dealing unless the wholesale basis is confirmed.
          Submit this form promptly so the interaction is centrally logged.
        </div>

        <div class="row">
          <div>
            <label for="timestamp">Server Timestamp (auto)</label>
            <input id="timestamp" type="text" readonly />
            <div class="small" style="margin-top:6px;color:var(--muted);">
              This timestamp is recorded on submission as well.
            </div>
          </div>
          <div>
            <label for="pathway">Wholesale pathway relied on</label>
            <select id="pathway">
              <option value="s708(8) Sophisticated (Accountant Certificate)">s708(8) Sophisticated (Accountant Certificate)</option>
              <option value="s708(10) Sophisticated (&gt;$500k investment)">s708(10) Sophisticated (&gt;$500k investment)</option>
              <option value="Professional Investor s708(11)">Professional Investor s708(11)</option>
              <option value="Other wholesale basis">Other wholesale basis</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="repName">Rep Name</label>
            <input id="repName" type="text" placeholder="Full name" />
          </div>
          <div>
            <label for="repEmail">Rep Email</label>
            <input id="repEmail" type="email" placeholder="name@domain.com" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="carName">CAR Name (if applicable)</label>
            <input id="carName" type="text" placeholder="Corporate Authorised Representative name" />
          </div>
          <div>
            <label for="stage">Stage</label>
            <select id="stage">
              <option value="Prospect only">Prospect only</option>
              <option value="Offer sent">Offer sent</option>
              <option value="Committed / applied">Committed / applied</option>
              <option value="Invested / settled">Invested / settled</option>
              <option value="Declined">Declined</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="investorName">Investor Name</label>
            <input id="investorName" type="text" placeholder="Full legal name" />
          </div>
          <div>
            <label for="investorEntity">Investor entity (company or trust if applicable)</label>
            <input id="investorEntity" type="text" placeholder="Company or trustee name" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="investorEmail">Investor email</label>
            <input id="investorEmail" type="email" placeholder="name@email.com" />
          </div>
          <div>
            <label for="investorPhone">Investor phone</label>
            <input id="investorPhone" type="text" placeholder="Mobile or landline" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="offerProduct">Offer / Product / Deal</label>
            <input id="offerProduct" type="text" placeholder="Example: placement or fund or strategy" />
          </div>
          <div>
            <label for="amount">Amount (AUD, optional)</label>
            <input id="amount" type="text" placeholder="Example: 250,000" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="certDate">Accountant certificate date (if used)</label>
            <input id="certDate" type="date" />
          </div>
          <div>
            <label for="accountant">Accountant name or firm (if applicable)</label>
            <input id="accountant" type="text" placeholder="Accountant or firm" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="wholesaleConfirmed">Wholesale confirmed before dealing</label>
            <select id="wholesaleConfirmed">
              <option value="Yes">Yes</option>
              <option value="Pending (do not proceed)">Pending (do not proceed)</option>
              <option value="No (do not proceed)">No (do not proceed)</option>
            </select>
          </div>
          <div>
            <label for="evidenceRef">Evidence reference (required)</label>
            <input id="evidenceRef" type="text" placeholder="Email date time plus filename or internal ref" />
            <div class="small" style="margin-top:6px;color:var(--muted);">
              After submission, email supporting material to Titan using your normal process.
              Do not upload confidential files to GitHub Pages.
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Short factual notes. Missing paperwork. Follow ups. Risk flags."></textarea>
        </div>

        <div class="inline">
          <span class="chip"><strong>Consent:</strong> This submission creates an internal log entry for supervision evidence.</span>
          <span class="chip"><strong>Retention:</strong> Keep your local records as usual.</span>
        </div>

        <div class="btns">
          <button class="primary" type="button" id="submitBtn">Submit and Log</button>
          <button class="ghost" type="button" id="downloadBtn">Download JSON Copy</button>
          <button class="secondary" type="button" id="copyEmailBtn">Copy Email Text</button>
          <button class="danger" type="button" id="resetBtn">Reset Form</button>
        </div>

        <div class="status" id="status"></div>

        <div class="footer">
          Note: Redact or amend any statement in this section if required.
        </div>
      </section>

      <aside class="card">
        <h2>Preview</h2>

        <div class="note">
          <strong>Central logging:</strong><br />
          This page posts to Titan’s s708 investor log endpoint and appends a new row in Google Sheets.
          A JSON copy is also downloaded as a backup evidence item.
        </div>

        <div style="margin-top:10px;" class="alert green">
          <strong>What gets logged:</strong><br />
          Timestamp, rep identity, CAR name, pathway, investor details, deal details, wholesale confirmation status, evidence reference, notes, and page URL.
        </div>

        <div style="margin-top:10px;">
          <label>Payload Preview</label>
          <div class="mono" id="preview">{}</div>
        </div>

        <div style="margin-top:10px;" class="note">
          <strong>Email backup:</strong><br />
          If logging is unavailable, use “Copy Email Text” and email the same details to Titan.
        </div>

        <div style="margin-top:10px;" class="note">
          <strong>Deployment:</strong><br />
          Version 3 (6 Jan 2026, 08:25)<br />
          Deployment ID: <span style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;">AKfycbwdywIS0u8cXhjtWWwoogbdLxwKG-5DZoAeu4XXSb8hpMTBuS7p3qdnJKTpkNkbR2Ua</span>
        </div>
      </aside>
    </div>
  </main>

  <script>
    const SHARED_PASSWORD = "titan";

    // ✅ UPDATED Web App URL (Version 3)
    const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbwdywIS0u8cXhjtWWwoogbdLxwKG-5DZoAeu4XXSb8hpMTBuS7p3qdnJKTpkNkbR2Ua/exec";

    const lock = document.getElementById("lock");
    const pw = document.getElementById("pw");
    const unlockBtn = document.getElementById("unlockBtn");
    const clearBtn = document.getElementById("clearBtn");
    const lockStatus = document.getElementById("lockStatus");

    function unlock(){
      const entered = (pw.value || "").trim();
      if(entered === SHARED_PASSWORD){
        lock.style.display = "none";
        lockStatus.textContent = "";
        localStorage.setItem("titan_708_unlocked", "1");
      } else {
        lockStatus.textContent = "Incorrect password.";
      }
    }

    unlockBtn.addEventListener("click", unlock);
    pw.addEventListener("keydown", (e) => { if(e.key === "Enter") unlock(); });
    clearBtn.addEventListener("click", () => { pw.value = ""; lockStatus.textContent = ""; });

    if(localStorage.getItem("titan_708_unlocked") === "1"){
      lock.style.display = "none";
    }

    const el = (id) => document.getElementById(id);

    const timestampEl = el("timestamp");
    const pathwayEl = el("pathway");
    const repNameEl = el("repName");
    const repEmailEl = el("repEmail");
    const carNameEl = el("carName");
    const stageEl = el("stage");

    const investorNameEl = el("investorName");
    const investorEntityEl = el("investorEntity");
    const investorEmailEl = el("investorEmail");
    const investorPhoneEl = el("investorPhone");

    const offerProductEl = el("offerProduct");
    const amountEl = el("amount");

    const certDateEl = el("certDate");
    const accountantEl = el("accountant");

    const wholesaleConfirmedEl = el("wholesaleConfirmed");
    const evidenceRefEl = el("evidenceRef");
    const notesEl = el("notes");

    const statusEl = el("status");
    const previewEl = el("preview");

    const submitBtn = el("submitBtn");
    const downloadBtn = el("downloadBtn");
    const copyEmailBtn = el("copyEmailBtn");
    const resetBtn = el("resetBtn");

    function isoNow(){
      return new Date().toISOString();
    }

    function setTimestamp(){
      timestampEl.value = isoNow();
    }

    function buildPayload(){
      return {
        server_timestamp: isoNow(),

        rep_name: (repNameEl.value || "").trim(),
        rep_email: (repEmailEl.value || "").trim(),
        car_name: (carNameEl.value || "").trim(),

        pathway: pathwayEl.value,
        stage: stageEl.value,

        investor_name: (investorNameEl.value || "").trim(),
        investor_entity: (investorEntityEl.value || "").trim(),
        investor_email: (investorEmailEl.value || "").trim(),
        investor_phone: (investorPhoneEl.value || "").trim(),

        offer_product: (offerProductEl.value || "").trim(),
        amount_aud: (amountEl.value || "").trim(),

        accountant_certificate_date: (certDateEl.value || "").trim(),
        accountant_name_or_firm: (accountantEl.value || "").trim(),

        wholesale_confirmed: wholesaleConfirmedEl.value,
        evidence_reference: (evidenceRefEl.value || "").trim(),
        notes: (notesEl.value || "").trim(),

        page_url: window.location.href,
        user_agent: navigator.userAgent
      };
    }

    function refreshPreview(){
      previewEl.textContent = JSON.stringify(buildPayload(), null, 2);
    }

    function downloadJSON(payload){
      const file = `titan_708_investor_${new Date().toISOString().replaceAll(":","").replaceAll(".","")}.json`;
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = file;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function buildEmailText(payload){
      const lines = [];
      lines.push("Subject: s708 investor logged – " + (payload.investor_name || "Investor") + " – " + payload.pathway);
      lines.push("");
      lines.push("Hi Matthew,");
      lines.push("");
      lines.push("I am logging an s708 / wholesale investor interaction for supervision verification.");
      lines.push("");
      lines.push("Timestamp: " + payload.server_timestamp);
      lines.push("Rep: " + payload.rep_name);
      lines.push("Rep Email: " + payload.rep_email);
      lines.push("CAR: " + (payload.car_name || "(none)"));
      lines.push("Pathway: " + payload.pathway);
      lines.push("Stage: " + payload.stage);
      lines.push("");
      lines.push("Investor: " + (payload.investor_name || ""));
      lines.push("Entity: " + (payload.investor_entity || ""));
      lines.push("Email: " + (payload.investor_email || ""));
      lines.push("Phone: " + (payload.investor_phone || ""));
      lines.push("");
      lines.push("Offer / Product: " + (payload.offer_product || ""));
      lines.push("Amount (AUD): " + (payload.amount_aud || ""));
      lines.push("");
      lines.push("Accountant cert date: " + (payload.accountant_certificate_date || ""));
      lines.push("Accountant: " + (payload.accountant_name_or_firm || ""));
      lines.push("");
      lines.push("Wholesale confirmed: " + payload.wholesale_confirmed);
      lines.push("Evidence reference: " + (payload.evidence_reference || ""));
      lines.push("");
      lines.push("Notes:");
      lines.push(payload.notes || "(not provided)");
      lines.push("");
      lines.push("Page URL: " + payload.page_url);
      lines.push("");
      lines.push("Regards,");
      lines.push(payload.rep_name || "Rep");
      return lines.join("\n");
    }

    async function postToEndpoint(payload){
      if(!LOG_ENDPOINT){
        return { ok:false, message:"LOG_ENDPOINT not configured." };
      }

      // Same as your working advertising form pattern:
      // - mode: no-cors
      // - Content-Type: text/plain;charset=utf-8
      try{
        await fetch(LOG_ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        return { ok:true, message:"Submitted. Check the Google Sheet for a new row if you need confirmation." };
      }catch(e){
        return { ok:false, message:"Endpoint call failed." };
      }
    }

    function validateMinimum(payload){
      if(!payload.rep_name) return "Enter Rep Name.";
      if(!payload.rep_email) return "Enter Rep Email.";
      if(!payload.investor_name) return "Enter Investor Name.";
      if(!payload.evidence_reference) return "Enter Evidence reference.";
      if(payload.wholesale_confirmed !== "Yes") return "Wholesale must be confirmed as Yes before submission.";
      return "";
    }

    [
      pathwayEl, repNameEl, repEmailEl, carNameEl, stageEl,
      investorNameEl, investorEntityEl, investorEmailEl, investorPhoneEl,
      offerProductEl, amountEl, certDateEl, accountantEl,
      wholesaleConfirmedEl, evidenceRefEl, notesEl
    ].forEach(x => x.addEventListener("input", refreshPreview));

    submitBtn.addEventListener("click", async () => {
      statusEl.textContent = "Submitting…";
      statusEl.style.color = "#4b5563";

      const payload = buildPayload();
      const err = validateMinimum(payload);
      refreshPreview();

      if(err){
        statusEl.textContent = err;
        statusEl.style.color = "#b71c1c";
        return;
      }

      downloadJSON(payload);

      const result = await postToEndpoint(payload);
      statusEl.textContent = result.ok
        ? ("Submitted. " + result.message + " A JSON copy was downloaded for your records.")
        : ("Submitted locally. " + result.message + " A JSON copy was downloaded for your records.");
      statusEl.style.color = result.ok ? "#0f766e" : "#b45309";

      setTimestamp();
    });

    downloadBtn.addEventListener("click", () => {
      const payload = buildPayload();
      refreshPreview();
      downloadJSON(payload);
      statusEl.textContent = "Downloaded JSON copy.";
      statusEl.style.color = "#0f766e";
    });

    copyEmailBtn.addEventListener("click", async () => {
      const payload = buildPayload();
      refreshPreview();
      const emailText = buildEmailText(payload);
      try{
        await navigator.clipboard.writeText(emailText);
        statusEl.textContent = "Email text copied to clipboard.";
        statusEl.style.color = "#0f766e";
      }catch(e){
        statusEl.textContent = "Clipboard blocked by browser. Copy from the preview panel.";
        statusEl.style.color = "#b45309";
        previewEl.textContent = emailText;
      }
    });

    resetBtn.addEventListener("click", () => {
      if(!confirm("Reset the form fields?")) return;

      repNameEl.value = "";
      repEmailEl.value = "";
      carNameEl.value = "";

      investorNameEl.value = "";
      investorEntityEl.value = "";
      investorEmailEl.value = "";
      investorPhoneEl.value = "";

      offerProductEl.value = "";
      amountEl.value = "";

      certDateEl.value = "";
      accountantEl.value = "";

      stageEl.value = "Prospect only";
      pathwayEl.value = "s708(8) Sophisticated (Accountant Certificate)";
      wholesaleConfirmedEl.value = "Pending (do not proceed)";
      evidenceRefEl.value = "";
      notesEl.value = "";

      statusEl.textContent = "Form reset.";
      statusEl.style.color = "#4b5563";
      setTimestamp();
      refreshPreview();
    });

    // Init
    setTimestamp();
    refreshPreview();
  </script>
</body>
</html>
